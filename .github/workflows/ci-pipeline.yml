name: CI Pipeline


on:
  pull_request:
    branches: [ "main" ]


env:
    AWS_DEFAULT_REGION: us-east-2
    AWS_DEFAULT_OUTPUT: json
    AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    CONTAINER_IMAGE: aws-devops-eks:${{ github.sha }}
  
permissions:
    contents: read
  
jobs:
    build_code:
      name: 'Code Build'
      runs-on: ubuntu-latest
  
      steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout
        uses: actions/checkout@v3
  
      # Set Pyhton environment
      - name: Set up Node 14
        uses: actions/setup-node@v3
        with:
            node-version: '14'        
      
      # Install dependencies
      - name: Clean & Install dependencies
        run: npm ci
  
      # Lint code
      - name: Lint Code
        run: npm run lint
  
      # Code Format using Prettier        
      - name: Code Format (Prettier)
        run: npm run prettier

      # Unit Test        
      - name: Unit Testing (Jest)
        run: npm test        

      # Production build distribution folder       
      - name: Build the code
        run: npm run build           
  
    build-and-push-image:
      needs: [build_code]
      name: 'Build and Push Docker Image'    
      runs-on: ubuntu-latest
      steps:
  
      - name: Checkout
        uses: actions/checkout@master
         
      - name: Login to ECR
        run: |
          # Login to AWS ECR
          $( aws ecr get-login --no-include-email )
  
      - name: Build and tag the image
        run: |
          # Build and tag the image
          docker build \
            -t $CONTAINER_IMAGE \
            -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CONTAINER_IMAGE ./app
  
      # Push to GitHub Registry  
      - name: Push to GitHub Registry
        run: |
            # Push image to AWS ECR
            docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$CONTAINER_IMAGE
